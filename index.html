<html>
	<head>
		<style>
			.resultsBox {
				border-style: solid;
				border-width: 1px;
			}
			.resultsRunning{
				background-color:#ADD8E6;
			}
			.resultsError{
			
			}
			.resultsValid{
			
			}
		</style>
		<title>
			The language of binary Addition.
		</title>
		<script src="parser.js"></script>
	</head>
	<body>
		<h1>The langauge of binary addition</h1>
		
		<label for="progInput">Enter your program here:</label>
		<textarea id="progInput" name="progInput"></textarea>
		<input type="button" id="goButton" onclick="parseAndRun()" value="Run program"	>
		<script>
		
			
			function parseAndRun() {
				
				var makeTree = function makeTree(rawInput) {
				
					return new Promise(function(resolve, reject) {
						try {
							resolve (parser.parse(rawInput));
						}
						catch (e) {
							reject({parseError:e});
						}
					});
				};
				
				
						
				makeTree(document.getElementById("progInput").value)
				.then(function(result) {
					alert("Prelim tree: " + JSON.stringify(result));
					alert(evaluateNode(result.baseNode, result.context));
				})
				.catch(
				function(err) {
					if (typeof err.parseError!=='undefined') {
						console.log(err);
						alert("Parse error: "+err.parseError.message);
					}
					else if (typeof err.compileError !=='undefined') {
						alert("compile error: " + err.compileError.message);
					}
					else if (typeof err.runError !== 'undefined') {
						alert("run error: " + err.runError);
					}
					else {
						alert("unknown error: "+ err);
					}
				});
				/*
			
				
				
				
				document.getElementById("resultDiv").classList.add("resultsRunning");
				var outputElement=document.getElementById("results");
				outputElement.innerHTML = "";
				
				//compiling
				
				compilerOutput = '';
				oldPrint = print;

				//running
				
				//print("AFTER EVALUATE");
				*/
			}

			function evaluateNode(node, context) {
				if (node.value.condF != undefined) {//boolean special case
					node.value.condL.value = evaluateNode(node.value.condL, context);
					node.value.condR.value = evaluateNode(node.value.condR, context);
					var useLeft = node.value.condF(node.value.condL.value, node.value.condR.value);
					if (useLeft) {
						node.value = evaluateNode(node.left, context);
						return node.value;
					}
					else {
						node.value = evaluateNode(node.right, context);
						return node.value;
					}
				}
				
				if (!isNaN(node.value)) {
					return node.value;
				}
				//http://stackoverflow.com/questions/5999998/how-can-i-check-if-a-javascript-variable-is-function-type
				else if (typeof node.value === "function" && Object.prototype.toString.call(node.value) == "[object Function]") {
					node.left = evaluateNode(node.left, context);
					node.right = evaluateNode(node.right, context);
					node.value = node.value(node.left, node.right);
					return node.value;
				}
				else if (typeof node.value === "string") {
					node.value = evaluateNode(context[node.value], context);
					return node.value;
				}
				else {
					console.log("Problem node value: ");
					console.log(node.value);
					throw {compileError:{message:"Unknown type for node value: " + node.value}};
				}
					
			}
			
			function genAssembly(parseTree) {
				var byteCode = ('target triple = "i386-pc-linux-gnu"\n'+

			'@.prf = private constant [2 x i8] c"%i"\n'+


			'define i32 @main() {\n'+
			'entry:\n'+
			  '%str1 = getelementptr inbounds [2 x i8]* @.prf, i32 0, i32 0\n'+ 
			  '%0 = add i32 ' + parseTree.arguments[0] + ',' + parseTree.arguments[2] + '\n'+
			  '%acall = call i32 (i8*,...)* @printf(i8* %str1, i32 %0)\n'+
			  'ret i32 1\n'+
			'}\n'+

			'declare i32 @printf(i8*, ...)\n');
			return llvmDis(llvmAs(byteCode)); 
			};
				</script>
		<p>Results: </p>		
		<div id="resultDiv" class="resultsBox">
			<p id ="results"></p>
		</div>
		<h3>Valid programs: </h3>
		<ul>
			<li>a and b must be positive integers</li>
			<li>does not care about whitespace</li>
			<li>Examples(remove quotes):</li>
			<ul>
				<li>"2+2"</li>
				<li>"4 + 8"</li>
			</ul>
		</ul>
		<h3>Supported Browsers</h3>
		<p>Can be used by any browser that supports JavaScript Promises such as latest versions of Firefox, Chrome, or Edge.</p>
	</body>
</html>